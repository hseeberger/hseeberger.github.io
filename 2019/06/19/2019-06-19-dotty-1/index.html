<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Martin Odersky’s keynote talk at Scala Days 2019 made me realize, that I should pay a lot more attention to Scala 3 (a.k.a. Dotty) than I did so far. For me it now seems like Scala 3 will be a huge im">
<meta property="og:type" content="article">
<meta property="og:title" content="Learn myself some Scala 3, episode 1: metaprogramming – inline">
<meta property="og:url" content="https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/index.html">
<meta property="og:site_name" content="Heiko&#39;s Blog">
<meta property="og:description" content="Martin Odersky’s keynote talk at Scala Days 2019 made me realize, that I should pay a lot more attention to Scala 3 (a.k.a. Dotty) than I did so far. For me it now seems like Scala 3 will be a huge im">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-06-19T00:00:00.000Z">
<meta property="article:modified_time" content="2022-02-11T23:56:50.315Z">
<meta property="article:author" content="Heiko Seeberger">
<meta property="article:tag" content="scala">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/img/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/img/favicon.ico" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon.ico">
        
      
    
    <!-- title -->
    <title>Learn myself some Scala 3, episode 1: metaprogramming – inline</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.0.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2019/12/04/2019-12-04-dotty-2/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2019/06/14/2019-06-14-scala-days-xtream/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&text=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&title=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&is_video=false&description=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Learn myself some Scala 3, episode 1: metaprogramming – inline&body=Check out this article: https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&title=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&title=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&title=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&title=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&name=Learn myself some Scala 3, episode 1: metaprogramming – inline&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&t=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Learn myself some Scala 3, episode 1: metaprogramming – inline
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Heiko Seeberger</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-06-19T00:00:00.000Z" itemprop="datePublished">2019-06-19</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/scala/" rel="tag">scala</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>Martin Odersky’s keynote talk at Scala Days 2019 made me realize, that I should pay a lot more attention to Scala 3 (a.k.a. Dotty) than I did so far. For me it now seems like Scala 3 will be a huge improvement over Scala 2, in particular because it significantly increases clearness and feature orthogonality. Just take a look at how the somewhat magic – and therefore hard to understand – realm of implicits has transitioned to <code>given</code> clauses which state the dependency on some “contextual” value and <code>delegate</code>s which allow us to define these values – just beautiful!</p>
<p>I have been travelling the Scala universe for long enough to take the timeline Martin presented – Scala 3 being released in 2020 – with a grain of salt, but nevertheless I think it is time to start learning myself some Scala 3 right away. And what could be better for learning something than writing about it? Hence I decided to write this blog post and hopefully some follow-up ones.</p>
<p>For this blog post I picked metaprogramming, which is a fairly advanced feature. Yet I will keep it super simple which is possible thanks to a new feature in Scala 3.</p>
<p>Some years ago, when I was learning Scala 2 macros, I created <a target="_blank" rel="noopener" href="https://github.com/lightbend/scala-logging">Scala Logging</a>, a convenient and fast logging library wrapping SLF4J, which has been improved and maintained by others for the past years. It is simple yet useful, because it allows developers to just call the logging methods like <code>debug</code>, which get expanded to the check-enabled-idiom. So let us see, how this can be done in Scala 3.</p>
<p>To make it crystal clear, the following is what we want to achieve. We want to be able to just call the <code>debug</code> method, without having to first check <code>isDebugEnabled</code>:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger.debug(hello())</span><br></pre></td></tr></table></figure>

<p>This should be compiled to the check-enabled-idiom, i.e. we want the <code>hello</code> method to be evaluated only if <code>isDebugEnabled</code> is <code>true</code>:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (logger.isDebugEnabled) logger.debug(hello())</span><br></pre></td></tr></table></figure>

<p>Scala 3 there comes with the new <code>inline</code> keyword which is sort of an enabler for various metaprogramming features like macros. But even on its own it is quite powerful as we will see.</p>
<p>An <code>inline</code>  method is guaranteed to be inlined by the Scala 3 compiler, which means that the method body will be expanded into any call site, i.e. any code which calls the respecive method. Hence we can define a <code>Logger</code> class which wraps an underlying <code>Logger</code> from <a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x">Log4j 2</a> and has an inlined <code>debug</code> method which takes the log message as a by-name parameter and applies the check-enabled-idiom:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.&#123; <span class="type">Logger</span> =&gt; <span class="type">Underlying</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Logger</span>(<span class="params">underlying: <span class="type">Underlying</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">inline</span> <span class="function"><span class="keyword">def</span> <span class="title">debug</span></span>(message: =&gt; <span class="type">String</span>): <span class="type">Unit</span> =</span><br><span class="line">    <span class="keyword">if</span> (underlying.isDebugEnabled) underlying.debug(message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now let us add some code using the above:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.<span class="type">LogManager</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> logger = <span class="keyword">new</span> <span class="type">Logger</span>(<span class="type">LogManager</span>.getLogger(getClass))</span><br><span class="line">  logger.debug(hello())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span></span>() = &#123;</span><br><span class="line">  println(<span class="string">&quot;********** hello() was called! **********&quot;</span>)</span><br><span class="line">  <span class="string">&quot;Hello!&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When we run this code, we see that the <code>hello</code> method only gets called, when the log level is set to <code>DEBUG</code>. This becomes clear by inspecting the code which gets generated by the Scala 3 compiler for the <code>main</code> method – we can use <code>javap</code> for this purpose:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  1: invokeinterface #42,  1  // InterfaceMethod rocks/heikoseeberger/log4dotty/Logging.logger:()Lrocks/heikoseeberger/log4dotty/Logger;</span><br><span class="line">  6: astore_2</span><br><span class="line">  7: aload_2</span><br><span class="line">  8: invokevirtual #48        // Method rocks/heikoseeberger/log4dotty/Logger.inline$underlying:()Lorg/apache/logging/log4j/Logger;</span><br><span class="line">11: invokeinterface #54,  1   // InterfaceMethod org/apache/logging/log4j/Logger.isDebugEnabled:()Z</span><br><span class="line">16: ifeq          38</span><br><span class="line">19: aload_2</span><br><span class="line">20: invokevirtual #48         // Method rocks/heikoseeberger/log4dotty/Logger.inline$underlying:()Lorg/apache/logging/log4j/Logger;</span><br><span class="line">23: aload_0</span><br><span class="line">24: invokespecial #58         // Method hello:()Ljava/lang/String;</span><br><span class="line">27: invokeinterface #62,  2   // InterfaceMethod org/apache/logging/log4j/Logger.debug:(Ljava/lang/String;)V</span><br><span class="line">32: getstatic     #68         // Field scala/runtime/BoxedUnit.UNIT:Lscala/runtime/BoxedUnit;</span><br><span class="line">35: goto          41</span><br><span class="line">38: getstatic     #68         // Field scala/runtime/BoxedUnit.UNIT:Lscala/runtime/BoxedUnit;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>As we can see, <code>hello</code> only gets called (pos. 24), if the check whether the <code>DEBUG</code> log level is enabled (pos. 11) has been <code>true</code>; else “nothing” happens, i.e. <code>Unit</code> is returned.</p>
<p>To sum it up, all we need to implement a convenient check-enabled logging library like Scala Logging in Scala 3, is the new <code>inline</code> feature – no further metaprogramming facilities like macros, which are also available in Scala 3, are necessary.</p>
<p>The full source code – in a little more polished fashion – can be found at <a target="_blank" rel="noopener" href="https://github.com/hseeberger/log4dotty">github.com&#x2F;hseeberger&#x2F;log4dotty</a>.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&text=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&title=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&is_video=false&description=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Learn myself some Scala 3, episode 1: metaprogramming – inline&body=Check out this article: https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&title=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&title=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&title=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&title=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&name=Learn myself some Scala 3, episode 1: metaprogramming – inline&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hseeberger.github.io/2019/06/19/2019-06-19-dotty-1/&t=Learn myself some Scala 3, episode 1: metaprogramming – inline"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2022
    Heiko Seeberger
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
