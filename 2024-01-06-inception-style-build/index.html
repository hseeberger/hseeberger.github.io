<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Or “The build within a build within …”Recently my colleagues at SCND and myself found ourselves facing an interesting challenge: building a Docker image of an application written in Rust and depending">
<meta property="og:type" content="article">
<meta property="og:title" content="Inception style builds with private GitHub dependencies">
<meta property="og:url" content="https://hseeberger.github.io/2024-01-06-inception-style-build/index.html">
<meta property="og:site_name" content="Heiko&#39;s Blog">
<meta property="og:description" content="Or “The build within a build within …”Recently my colleagues at SCND and myself found ourselves facing an interesting challenge: building a Docker image of an application written in Rust and depending">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-01-06T00:00:00.000Z">
<meta property="article:modified_time" content="2025-01-15T08:54:35.442Z">
<meta property="article:author" content="Heiko Seeberger">
<meta property="article:tag" content="rust">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/img/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/img/favicon.ico" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon.ico">
        
      
    
    <!-- title -->
    <title>Inception style builds with private GitHub dependencies</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<!-- hexo injector head_end start --><script async defer data-domain="heikoseeberger.de" src="https://plausible.io/js/plausible.js" ></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025-01-15-concurrent-parallel-futures/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024-01-01-printing-errors/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hseeberger.github.io/2024-01-06-inception-style-build/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&text=Inception style builds with private GitHub dependencies"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&title=Inception style builds with private GitHub dependencies"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&is_video=false&description=Inception style builds with private GitHub dependencies"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Inception style builds with private GitHub dependencies&body=Check out this article: https://hseeberger.github.io/2024-01-06-inception-style-build/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&title=Inception style builds with private GitHub dependencies"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&title=Inception style builds with private GitHub dependencies"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&title=Inception style builds with private GitHub dependencies"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&title=Inception style builds with private GitHub dependencies"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&name=Inception style builds with private GitHub dependencies&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hseeberger.github.io/2024-01-06-inception-style-build/&t=Inception style builds with private GitHub dependencies"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Or-%E2%80%9CThe-build-within-a-build-within-%E2%80%A6%E2%80%9D"><span class="toc-number">1.</span> <span class="toc-text">Or “The build within a build within …”</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-build"><span class="toc-number">1.1.</span> <span class="toc-text">Docker build</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dependencies-on-libraries-in-private-GitHub-repository"><span class="toc-number">1.2.</span> <span class="toc-text">Dependencies on libraries in private GitHub repository</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Integration"><span class="toc-number">1.3.</span> <span class="toc-text">Integration</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Inception style builds with private GitHub dependencies
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Heiko Seeberger</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-01-06T00:00:00.000Z" itemprop="datePublished">2024-01-06</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/rust/" rel="tag">rust</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="Or-“The-build-within-a-build-within-…”"><a href="#Or-“The-build-within-a-build-within-…”" class="headerlink" title="Or “The build within a build within …”"></a>Or “The build within a build within …”</h1><p>Recently my colleagues at <a target="_blank" rel="noopener" href="https://www.scnd.com/">SCND</a> and myself found ourselves facing an interesting challenge: building a Docker image of an application written in Rust and depending on Rust libraries in private GitHub repositories; of course not locally, but via GitHub Actions.</p>
<p>So this can be broken down into a couple of smaller challenges:</p>
<ol>
<li>Build a Docker image of a Rust application in GitHub Actions.</li>
<li>Depend on a library in a private GitHub repository in GitHub Actions.</li>
<li>See how to integrate the two above.</li>
</ol>
<h2 id="Docker-build"><a href="#Docker-build" class="headerlink" title="Docker build"></a>Docker build</h2><p>There are fantastic publicly available GitHub Actions to build (and publish) a Docker image, e.g. <code>docker/metadata-action</code>, <code>docker/login-action</code> and in particular <code>build-push-action</code>. Given a <code>Dockerfile</code> and the necessary GitHub permissions, a partial workflow could look like this:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">release</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">v*</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">release:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Docker</span> <span class="string">metadata</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/metadata-action@v5</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">meta</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">images:</span> <span class="string">ghcr.io/&lt;ORGANIZATION&gt;/$&#123;&#123;</span> <span class="string">github.event.repository.name</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">tags:</span> <span class="string">type=semver,pattern=&#123;&#123;version&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Login</span> <span class="string">to</span> <span class="string">GitHub</span> <span class="string">Container</span> <span class="string">Registry</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/login-action@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">registry:</span> <span class="string">ghcr.io</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.actor</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Docker</span> <span class="string">build</span> <span class="string">and</span> <span class="string">push</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/build-push-action@v5</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">tags:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.meta.outputs.tags</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">labels:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.meta.outputs.labels</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">push:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>And a <code>Dockerfile</code> could look like this:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> RUST_VERSION=<span class="number">1.75</span>.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> rust:$&#123;RUST_VERSION&#125;-bookworm AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> \</span></span><br><span class="line"><span class="language-bash">  --mount=<span class="built_in">type</span>=cache,target=/app/target/ \</span></span><br><span class="line"><span class="language-bash">  --mount=<span class="built_in">type</span>=cache,target=/usr/local/cargo/registry/ \</span></span><br><span class="line"><span class="language-bash">  cargo build --release &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">  <span class="built_in">cp</span> ./target/release/&lt;APP&gt; /</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> debian:bookworm-slim AS final</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> adduser \</span></span><br><span class="line"><span class="language-bash">  --disabled-password \</span></span><br><span class="line"><span class="language-bash">  --gecos <span class="string">&quot;&quot;</span> \</span></span><br><span class="line"><span class="language-bash">  --home <span class="string">&quot;/nonexistent&quot;</span> \</span></span><br><span class="line"><span class="language-bash">  --shell <span class="string">&quot;/sbin/nologin&quot;</span> \</span></span><br><span class="line"><span class="language-bash">  --no-create-home \</span></span><br><span class="line"><span class="language-bash">  --uid <span class="string">&quot;10001&quot;</span> \</span></span><br><span class="line"><span class="language-bash">  appuser</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /&lt;APP&gt; /usr/local/bin</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chown</span> appuser /usr/local/bin/&lt;APP&gt;</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/config /opt/&lt;APP&gt;/config</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chown</span> -R appuser /opt/&lt;APP&gt;</span></span><br><span class="line"><span class="keyword">USER</span> appuser</span><br><span class="line"><span class="keyword">ENV</span> RUST_LOG=<span class="string">&quot;&lt;APP&gt;=debug,info&quot;</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt/&lt;APP&gt;</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;&lt;APP&gt;&quot;</span>]</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span>/tcp</span><br></pre></td></tr></table></figure>

<p>Unless the application depends on libraries in private GitHub repositories, the <code>release</code> job will execute successfully.</p>
<h2 id="Dependencies-on-libraries-in-private-GitHub-repository"><a href="#Dependencies-on-libraries-in-private-GitHub-repository" class="headerlink" title="Dependencies on libraries in private GitHub repository"></a>Dependencies on libraries in private GitHub repository</h2><p>Locally we can easily depend on libraries in private GitHub repositories using Cargo’s <code>git</code> dependency feature with ssh URLs:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo = &#123; git = &quot;ssh://git@github.com/&lt;&lt;ORGANIZATION&gt;&gt;/foo&quot; &#125;</span><br></pre></td></tr></table></figure>

<p>For this to work, we just need to have our personal public SSH key registered at GitHub, what most every developer has. We also have to tweak a specific Cargo setting via the <code>.cargo/config.toml</code> file:</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[net]</span></span><br><span class="line"><span class="attr">git-fetch-with-cli</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>If we want CI to be able to build and test applications with such ssh dependencies, we have to put in some more effort. First we need to create a pair of SSH keys. Then we add the public one as deploy key to the GitHub repository which hosts the library dependency. Next we add the private key as action secret to the GitHub repository of the application. And finally we add the fantastic public <code>webfactory/ssh-agent</code> GitHub Action to our build:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">SSH</span> <span class="string">agent</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">webfactory/ssh-agent@v0.8.0</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">ssh-private-key:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.&lt;PRIVATE_KEY&gt;</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>With all that in place, we can write workflows with jobs&#x2F;steps to compile, test, etc. our application. But all of that takes place within the GitHub runner. It is still not possible to execute the above <code>release</code> job.</p>
<p>Why? Because the <code>webfactory/ssh-agent</code> GitHub Action does the “SSH magic”, but only within the context of the GitHub runner. When GitHub Actions starts the Docker build which then starts the build of the Rust application – notice the build within a build within … – neither the SSH public key of the GitHub server hosting the library nor the private key for accessing that repository are available.</p>
<h2 id="Integration"><a href="#Integration" class="headerlink" title="Integration"></a>Integration</h2><p>Luckily it is quite easy to solve the resulting challenge. There are numerous somewhat relevant examples in the internet, but none could be found for our exact use case. Yet we were able to put the pieces together.</p>
<p>First the SSH agent socket needs to be passed down to the Docker build, which can be achieved via the ssh option of the <code>docker/build-push-action</code> GitHub action:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Docker</span> <span class="string">build</span> <span class="string">and</span> <span class="string">push</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">docker/build-push-action@v5</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.meta.outputs.tags</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">labels:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.meta.outputs.labels</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">push:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">ssh:</span> <span class="string">default=$&#123;&#123;</span> <span class="string">env.SSH_AUTH_SOCK</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>This essentially makes the private SSH key for the library in the private GitHub repository available within the Docker build. In order to also make it available one <del>dream</del> build level deeper, i.e. in the Rust build, the respective <code>RUN</code> needs to be given the <code>--mount=type=ssh</code> option:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> \</span></span><br><span class="line"><span class="language-bash">  --mount=<span class="built_in">type</span>=cache,target=/app/target/ \</span></span><br><span class="line"><span class="language-bash">  --mount=<span class="built_in">type</span>=cache,target=/usr/local/cargo/registry/ \</span></span><br><span class="line"><span class="language-bash">  --mount=<span class="built_in">type</span>=ssh \</span></span><br><span class="line"><span class="language-bash">  cargo build --release &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">  <span class="built_in">cp</span> ./target/release/&lt;APP&gt; /</span></span><br></pre></td></tr></table></figure>

<p>Now we are almost there. The last missing piece is to add the public key of the GitHub server to the <code>known_hosts</code> file in the builder layer in the Dockerfile, of course before the above build:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> \</span></span><br><span class="line"><span class="language-bash">  apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">  apt-get install -y jq &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">  <span class="built_in">mkdir</span> -p -m 0700 ~/.ssh &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">  curl --silent https://api.github.com/meta  | jq --raw-output <span class="string">&#x27;&quot;github.com &quot;+.ssh_keys[]&#x27;</span> &gt;&gt; ~/.ssh/known_hosts &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">  <span class="built_in">chmod</span> 600 ~/.ssh/known_hosts</span></span><br></pre></td></tr></table></figure>

<p>Phew, we are finally there! So it turns out that the essence of making this work is to pass the private SSH key down from the “top level” build, where it is defined as an action secret, to the Docker build from where it needs to be passed down to the Rust build. Inception at its best! Of course we also must not forget to add the public key of the GitHub server to <code>known_hosts</code>.</p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Or-%E2%80%9CThe-build-within-a-build-within-%E2%80%A6%E2%80%9D"><span class="toc-number">1.</span> <span class="toc-text">Or “The build within a build within …”</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-build"><span class="toc-number">1.1.</span> <span class="toc-text">Docker build</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dependencies-on-libraries-in-private-GitHub-repository"><span class="toc-number">1.2.</span> <span class="toc-text">Dependencies on libraries in private GitHub repository</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Integration"><span class="toc-number">1.3.</span> <span class="toc-text">Integration</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://hseeberger.github.io/2024-01-06-inception-style-build/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&text=Inception style builds with private GitHub dependencies"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&title=Inception style builds with private GitHub dependencies"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&is_video=false&description=Inception style builds with private GitHub dependencies"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Inception style builds with private GitHub dependencies&body=Check out this article: https://hseeberger.github.io/2024-01-06-inception-style-build/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&title=Inception style builds with private GitHub dependencies"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&title=Inception style builds with private GitHub dependencies"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&title=Inception style builds with private GitHub dependencies"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&title=Inception style builds with private GitHub dependencies"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://hseeberger.github.io/2024-01-06-inception-style-build/&name=Inception style builds with private GitHub dependencies&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://hseeberger.github.io/2024-01-06-inception-style-build/&t=Inception style builds with private GitHub dependencies"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    Heiko Seeberger
  </div>
  <div><a rel="me noopener" target="_blank" href="https://hachyderm.io/@hseeberger"></a></div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>
    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'hseeberger/comments';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'utteranc';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
